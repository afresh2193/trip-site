<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travel Map + Trips</title>

<style>
body { margin:0; font-family: Arial,sans-serif; background:#f2f2f2; }

/* ---------- HEADER ---------- */
.header {
  background:#333; color:white; text-align:center; padding:20px;
}
.header h1 { margin:0; font-size:32px; }
.header p { margin:5px 0 0; font-size:16px; }

/* ---------- FILTERS ---------- */
#filters {
  position:absolute; z-index:999;
  background:white; padding:10px; margin:10px;
  border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

/* ---------- CONTAINER ---------- */
#container {
  display:flex;
  height:80vh;
  min-height:500px;
}

#map-container { flex:3; padding:10px; }
#map { width:100%; height:100%; }

#details-panel {
  flex:1;
  background:#f9f9f9;
  padding:15px;
  overflow-y:auto;
  border-left:1px solid #ccc;
}

#details-panel img { width:100%; margin-bottom:15px; }

.go-to-page-btn {
  background:#28a745;
  color:white;
  padding:12px;
  border:none;
  width:100%;
  font-size:18px;
  cursor:pointer;
  margin-top:15px;
}
.go-to-page-btn:hover { background:#218838; }

/* ---------- SPACER ---------- */
.spacer { height:40px; }

/* ---------- TRIPS TABLE ---------- */
table {
  width:100%;
  border-collapse:collapse;
  background:#2b2b2b;
  font-size:12.5px;
  margin-bottom:40px;
}

th, td {
  padding:8px 10px;
  border-bottom:1px solid #444;
  white-space:nowrap;
  text-align:left;
}

th { background:#3a3a3a; cursor:pointer; }

tbody tr:nth-child(odd) { background:#2b2b2b; }
tbody tr:nth-child(even) { background:#303030; }

tbody tr:hover { background:#3f3f3f !important; }

.dot {
  width:10px; height:10px; border-radius:50%; display:inline-block;
}
</style>
</head>

<body>

<div class="header">
  <h1>My Travel Map</h1>
  <p>Click a location to view the trip gallery</p>
</div>

<div id="filters">
  <label>
    Type:
    <select id="typeFilter">
      <option value="All">All</option>
      <option value="Hike">Hike</option>
      <option value="Backpack">Backpack</option>
      <option value="Kayak">Kayak</option>
      <option value="Other">Other</option>
    </select>
  </label>
</div>

<div id="container">
  <div id="map-container">
    <div id="map"></div>
  </div>
  <div id="details-panel">
    <div id="details-content">Select a marker to see details</div>
  </div>
</div>

<div class="spacer"></div>

<table id="tripsTable">
<thead>
<tr>
  <th></th>
  <th>Hike</th>
  <th>Area</th>
  <th>Type</th>
  <th>Miles</th>
  <th>Gain</th>
  <th>Rank</th>
  <th>Date</th>
  <th>Year</th>
  <th>Image</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
/* ===== CONFIG ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_5e7cG_REtJkwr6TPDp4oWLoi6H52u3EBswtjLmzvM1UT5bSxDKp3P4SQ5tBoMMYf/exec";
const GOOGLE_MAPS_KEY = "AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA";

let map;
let allMarkersData = [];
let mapMarkers = [];

/* ===== INIT MAP ===== */
function initMap(){
  map = new google.maps.Map(document.getElementById("map"),{
    center:{lat:36.805098,lng:-109.822512},
    zoom:6,
    mapTypeId:"terrain",
    gestureHandling:"greedy",
    disableDefaultUI:true
  });
  loadTrips();
}

/* ===== LOAD TRIPS FROM APPS SCRIPT ===== */
function loadTrips(){
  fetch(SCRIPT_URL)
    .then(res=>res.json())
    .then(data=>{
      allMarkersData = data.cardItems;
      updateMarkers();
      const sorted = [...allMarkersData].sort((a,b)=> new Date(b.date)-new Date(a.date));
      if(sorted.length) showDetails(sorted[0]);
      loadTable(sorted);
    });
}

/* ===== MARKER ICONS ===== */
function getMarkerIcon(type){
  switch(type?.toLowerCase()){
    case "hike": return "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
    case "backpack": return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
    case "kayak": return "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
    default: return "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
  }
}

/* ===== UPDATE MAP MARKERS ===== */
function updateMarkers(){
  mapMarkers.forEach(m=>m.setMap(null));
  mapMarkers=[];
  const selected = document.getElementById("typeFilter").value;
  allMarkersData.forEach(d=>{
    if(selected!=="All" && d.type!==selected) return;
    if(!d.position) return;
    const marker = new google.maps.Marker({
      position:d.position,
      map,
      icon:getMarkerIcon(d.type)
    });
    marker.addListener("click",()=>showDetails(d));
    mapMarkers.push(marker);
  });
}

document.getElementById("typeFilter").addEventListener("change",updateMarkers);

/* ===== SHOW SIDEBAR DETAILS ===== */
function showDetails(data){
  const urls = data.imageUrl?.split(",").map(u=>u.trim()) || [];
  const imagesHtml = urls.map(u=>`<img src="${u}">`).join("");
  document.getElementById("details-content").innerHTML=`
    <h2>${data.title}</h2>
    ${imagesHtml}
    <p><strong>Area:</strong> ${data.area}</p>
    <p><strong>Date:</strong> ${data.date}</p>
    <p><strong>Miles:</strong> ${data.miles}</p>
    <p><strong>Elevation Gain:</strong> ${data.elevationGain}</p>
    <button class="go-to-page-btn">Go to Page</button>
  `;
  document.querySelector(".go-to-page-btn").onclick=()=>{
    const slug = data.title.toLowerCase().replace(/\s+/g,'-');
    window.location.href = `trip-gallery.html?slug=${slug}`;
  };
}

/* ===== TRIPS TABLE BELOW MAP ===== */
function formatDate(d) {
  const x = new Date(d);
  return isNaN(x) ? '' : `${x.getMonth()+1}-${x.getDate()}-${x.getFullYear()}`;
}
function getYear(d) {
  const x = new Date(d);
  return isNaN(x) ? '' : x.getFullYear();
}
function getDotColor(type='') {
  return {
    hike:'#6188e6',
    backpack:'#fd7567',
    kayak:'#00e74c',
    other:'#ede562'
  }[type.toLowerCase()] || '#999';
}

function loadTable(data){
  const tbody = document.querySelector('#tripsTable tbody');
  tbody.innerHTML = '';
  data.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="dot" style="background:${getDotColor(item.type)}"></span></td>
      <td data-label="Hike">${item.title}</td>
      <td data-label="Area">${item.area}</td>
      <td data-label="Type">${item.type}</td>
      <td data-label="Miles">${item.miles}</td>
      <td data-label="Gain">${item.elevationGain.toLocaleString()}</td>
      <td data-label="Rank">${item.overallRanking}</td>
      <td data-label="Date">${formatDate(item.date)}</td>
      <td data-label="Year">${getYear(item.date)}</td>
      <td data-label="Image">${item.imageUrl || ''}</td>
    `;
    tr.onclick = () => {
      const slug = item.title.toLowerCase().replace(/\s+/g,'-');
      window.location.href = `trip-gallery.html?slug=${slug}`;
    };
    tbody.appendChild(tr);
  });
}
</script>

<!-- ===== LOAD GOOGLE MAPS ===== -->
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA&callback=initMap">
</script>

</body>
</html>
