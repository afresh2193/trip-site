<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travel Map</title>

<style>
body { margin:0; font-family: Arial,sans-serif; background:#f2f2f2; }

.header {
  background:#333; color:white; text-align:center; padding:20px;
}
.header h1 { margin:0; font-size:32px; }
.header p { margin:5px 0 0; font-size:16px; }

#filters {
  position:absolute; z-index:999;
  background:white; padding:10px; margin:10px;
  border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

#container {
  display:flex;
  height:80vh;
  min-height:500px;
}

#map-container { flex:3; padding:10px; }

#map { width:100%; height:100%; }

#details-panel {
  flex:1;
  background:#f9f9f9;
  padding:15px;
  overflow-y:auto;
  border-left:1px solid #ccc;
}

#details-panel img {
  width:100%;
  margin-bottom:15px;
}

.go-to-page-btn {
  background:#28a745;
  color:white;
  padding:12px;
  border:none;
  width:100%;
  font-size:18px;
  cursor:pointer;
  margin-top:15px;
}

.go-to-page-btn:hover { background:#218838; }

/* ===== Spacer ===== */
.section-spacer {
  height:60px;
  background:#f2f2f2;
}

/* ===== WriteUp Section ===== */
#writeup-section {
  background:#ffffff;
  padding:40px;
  max-width:900px;
  margin:0 auto 60px auto;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  border-radius:8px;
}

#writeup-section h2 {
  margin-top:0;
}

@media(max-width:900px){
  #container { flex-direction:column; }
  #details-panel {
    border-left:none;
    border-top:1px solid #ccc;
  }
}
</style>

</head>
<body>

<div class="header">
  <h1>My Travel Map</h1>
  <p>Click a location to view the trip gallery</p>
</div>

<div id="filters">
  <label>
    Type:
    <select id="typeFilter">
      <option value="All">All</option>
      <option value="Hike">Hike</option>
      <option value="Backpack">Backpack</option>
      <option value="Kayak">Kayak</option>
      <option value="Other">Other</option>
    </select>
  </label>
</div>

<div id="container">
  <div id="map-container">
    <div id="map"></div>
  </div>
  <div id="details-panel">
    <div id="details-content">Loading...</div>
  </div>
</div>

<!-- Spacer -->

<div class="section-spacer"></div>

<!-- WriteUp Section -->

<div id="writeup-section">
  <h2>Trip Write-Up</h2>
  <div id="writeup-content">
    Click a trip marker to read the full write-up.
  </div>
</div>

<script>
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycby_5e7cG_REtJkwr6TPDp4oWLoi6H52u3EBswtjLmzvM1UT5bSxDKp3P4SQ5tBoMMYf/exec";

const GOOGLE_MAPS_KEY =
"AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA";

let map;
let allMarkersData = [];
let mapMarkers = [];
let writeups = {};

function initMap(){

  map = new google.maps.Map(document.getElementById("map"),{
    center:{lat:36.805098,lng:-109.822512},
    zoom:6,
    mapTypeId:"terrain",
    gestureHandling:"greedy",
    disableDefaultUI:true
  });

  loadTrips();
}

function loadTrips(){
  fetch(SCRIPT_URL)
    .then(res=>res.json())
    .then(data=>{
      allMarkersData = data.cardItems;
      writeups = data.writeups || {};
      updateMarkers();

      const sorted = [...allMarkersData]
        .sort((a,b)=> new Date(b.date)-new Date(a.date));

      if(sorted.length) showDetails(sorted[0]);
    });
}

function getMarkerIcon(type){
  switch(type?.toLowerCase()){
    case "hike": return "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
    case "backpack": return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
    case "kayak": return "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
    default: return "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
  }
}

function updateMarkers(){

  mapMarkers.forEach(m=>m.setMap(null));
  mapMarkers=[];

  const selected =
    document.getElementById("typeFilter").value;

  allMarkersData.forEach(d=>{

    if(selected!=="All" && d.type!==selected) return;
    if(!d.position) return;

    const marker = new google.maps.Marker({
      position:d.position,
      map,
      icon:getMarkerIcon(d.type)
    });

    marker.addListener("click",()=>showDetails(d));
    mapMarkers.push(marker);
  });
}

document
.getElementById("typeFilter")
.addEventListener("change",updateMarkers);

function showDetails(data){

  const urls =
    data.imageUrl?.split(",").map(u=>u.trim()) || [];

  const imagesHtml =
    urls.map(u=>`<img src="${u}">`).join("");

  const slug =
    data.title.toLowerCase().replace(/\s+/g,'-');

  const writeupText =
    writeups[slug] || "No write-up available.";

  document.getElementById("details-content").innerHTML=`
    <h2>${data.title}</h2>
    ${imagesHtml}
    <p><strong>Area:</strong> ${data.area}</p>
    <p><strong>Date:</strong> ${data.date}</p>
    <p><strong>Miles:</strong> ${data.miles}</p>
    <p><strong>Elevation Gain:</strong> ${data.elevationGain}</p>
    <button class="go-to-page-btn">Go to Page</button>
  `;

  document
  .getElementById("writeup-content")
  .innerHTML = writeupText;

  document
  .querySelector(".go-to-page-btn")
  .onclick=()=>{
    window.location.href =
      `trip-gallery.html?slug=${slug}`;
  };
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA&callback=initMap">
</script>

</body>
</html>
