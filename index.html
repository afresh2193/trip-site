<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Travel Map</title>

<style>
body { 
  margin:0; 
  font-family: Arial,sans-serif; 
  background:#f2f2f2; 
  padding-top:60px;
  box-sizing:border-box;
}

/* ===== HEADER ===== */
.header {
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 999;
  background:#333; 
  color:white; 
  text-align:center; 
  padding:12px 20px;
}

/* ===== SHARED WIDTH ===== */
.page-width {
  max-width:1480px;   /* Wider */
  margin:0 auto;
  padding:0 12px;
}

/* ===== FILTERS ===== */
#filters {
  background:white;
  padding:12px;
  margin:15px 0 5px 0;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

#filters label {
  font-size:14px;
}

/* ===== MAP + SIDEBAR ===== */
#container {
  display:flex;
  height:80vh;
  min-height:520px;
}

#map-container { 
  flex:3;
  padding:10px 10px 10px 0;  /* Fix width mismatch */
}

#map { 
  width:100%; 
  height:100%; 
}

#details-panel {
  flex:1;
  background:#f9f9f9;
  padding:15px;
  overflow-y:auto;
  border-left:1px solid #ccc;
}

#details-panel img { width:100%; margin-bottom:15px; }

/* ===== CARDS ===== */
.cards-container {
  display:flex;
  flex-direction:column;
  gap:20px;
  max-width:1480px;   /* Match map */
  margin:40px auto;
  padding:0 12px;
}

.trip-card {
  display:flex;
  background:#fff;
  cursor:pointer;
  border-radius:8px;
  overflow:hidden;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
}

.trip-info {
  flex:.8;
  background:#333;
  color:white;
  padding:20px;
  min-width:200px;
}

.trip-photo {
  flex:3.2;
  background-size:cover;
  background-position:center;
  min-height:420px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h1>My Travel Map</h1>
</div>

<div class="page-width">

  <!-- FILTERS -->
  <div id="filters">
    
    <label>
      Type:
      <select id="typeFilter">
        <option value="All">All</option>
        <option value="Hike">Hike</option>
        <option value="Backpack">Backpack</option>
        <option value="Kayak">Kayak</option>
        <option value="Other">Other</option>
      </select>
    </label>

    <label>
      Year:
      <select id="yearFilter">
        <option value="All">All</option>
      </select>
    </label>

    <label>
      Miles:
      <select id="milesFilter">
        <option value="All">All</option>
        <option value="0-1000">0-1000</option>
        <option value="1000-2000">1000-2000</option>
        <option value="2000-3000">2000-3000</option>
        <option value="3000-4000">3000-4000</option>
        <option value="4000-5000">4000-5000</option>
        <option value="5000+">5000+</option>
      </select>
    </label>

  </div>

  <!-- MAP + SIDEBAR -->
  <div id="container">

    <div id="map-container">
      <div id="map"></div>
    </div>

    <div id="details-panel">
      <div id="details-content">Loading...</div>
    </div>

  </div>

</div>

<!-- CARDS -->
<div class="cards-container" id="cards-container">
  Loading trips...
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycby_5e7cG_REtJkwr6TPDp4oWLoi6H52u3EBswtjLmzvM1UT5bSxDKp3P4SQ5tBoMMYf/exec";

let map;
let allTrips=[];
let markers=[];

function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:36.8,lng:-109.8},
    zoom:6,
    mapTypeId:"terrain",
    disableDefaultUI:true
  });
  loadTrips();
}

function loadTrips(){
  fetch(SCRIPT_URL)
  .then(r=>r.json())
  .then(data=>{
    allTrips=data.cardItems;
    populateYearFilter();
    applyFilters();
  });
}

/* ===== FILTER HELPERS ===== */

function populateYearFilter(){
  const years=[...new Set(
    allTrips.map(t=> new Date(t.date).getFullYear())
  )].sort((a,b)=>b-a);

  const sel=document.getElementById("yearFilter");

  years.forEach(y=>{
    const o=document.createElement("option");
    o.value=y;
    o.textContent=y;
    sel.appendChild(o);
  });
}

function milesMatch(miles,bucket){
  miles=parseFloat(miles)||0;

  if(bucket==="All") return true;
  if(bucket==="5000+") return miles>=5000;

  const [min,max]=bucket.split("-").map(Number);
  return miles>=min && miles<max;
}

/* ===== APPLY FILTERS ===== */

function applyFilters(){

  const type=document.getElementById("typeFilter").value;
  const year=document.getElementById("yearFilter").value;
  const miles=document.getElementById("milesFilter").value;

  const filtered=allTrips.filter(t=>{

    if(type!=="All" && t.type!==type) return false;

    if(year!=="All"){
      if(new Date(t.date).getFullYear()!=year) return false;
    }

    if(!milesMatch(t.miles,miles)) return false;

    return true;
  });

  updateMarkers(filtered);
  loadCards(filtered);
}

/* ===== MARKERS ===== */

function updateMarkers(trips){

  markers.forEach(m=>m.setMap(null));
  markers=[];

  trips.forEach(t=>{
    if(!t.position) return;

    const m=new google.maps.Marker({
      position:t.position,
      map
    });

    markers.push(m);
  });
}

/* ===== CARDS ===== */

function loadCards(trips){

  const c=document.getElementById("cards-container");
  c.innerHTML="";

  trips.forEach(t=>{
    const d=document.createElement("div");
    d.className="trip-card";
    d.innerHTML=`
      <div class="trip-info">
        <p><strong>${t.title}</strong></p>
        <p>${t.area||""}</p>
        <p>${t.date}</p>
        <p>${t.miles} miles</p>
      </div>
      <div class="trip-photo"
        style="background-image:url('${t.imageUrl||""}')">
      </div>
    `;
    c.appendChild(d);
  });
}

/* ===== EVENTS ===== */
document.querySelectorAll("#filters select")
.forEach(s=>s.addEventListener("change",applyFilters));
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA&callback=initMap">
</script>

</body>
</html>
